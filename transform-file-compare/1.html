<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="X-UA-Compatible" content="ie=edge" />
        <title>Document</title>
        <script src="../my-min-library/Crypto.js"></script>
        <script src="../my-min-library/jquery.dev.js"></script>
        <style>
            .holder {
                width: 300px;
                border: 10px dashed #ccc;
                height: 300px;
            }
            .live {
                font-size: 24px;
                color: red;
            }
        </style>
    </head>
    <body>
        已有 <span class="live" id="live">0</span> 个文件准备用来比较<br />
        <div class="holder" ondragover="return false;" ondragend="return false;" ondrop="handle(event)"></div>
        <span class="result" id="file1"></span><br />
        <span class="result" id="file2"></span><br />
        <span class="live" id="result"></span><br />
        <button style="width: 100px;height: 40px;" onclick="clearAll()">clear</button>
        <script>
            let targets = [];
            async function handle(e) {
                e.preventDefault();
                const files = e.dataTransfer.files;
                [].forEach.call(files, file => {
                    targets.push(file);
                    updateNumOfFiles();
                });
                if (targets.length === 2) {
                    await process();
                }
            }
            function getMd5(file) {
                return new Promise(res => {
                    const reader = new FileReader();
                    reader.readAsBinaryString(file);
                    reader.onload = function() {
                        res(CryptoJS.MD5(reader.result).toString());
                    };
                });
            }
            function updateNumOfFiles() {
                if (targets.length > 2) {
                    targets.length = 0;
                    $(".result").html("");
                    $(".live").html("");
                }
                $("#live").html(targets.length);
            }
            async function process() {
                let i = 0;
                for await (md5 of targets.map(getMd5)) {
                    $("#file" + ++i).html(md5);
                }
                $("#result").html($("#file1").html() === $("#file2").html() ? "相同" : "不同");
                return;
            }
            function clearAll() {
                $(".result").html("");
                $(".live").html("");
                $("#live").html(0);
                targets.length = 0;
            }
        </script>
    </body>
</html>
